name: Demo SBOM pipeline

on:
  workflow_dispatch:
  push:
    branches: [ main, docs-reorg ]

permissions:
  id-token: write   # required for GitHub OIDC
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 005965605891

jobs:
  generate-and-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GitHubActionsOIDCRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up syft + trivy
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SBOM (syft)
        run: |
          syft . -o json > output/sbom.json

      - name: Scan (trivy)
        run: |
          trivy filesystem --format json -o output/scan.json . || true

      - name: Upload artifacts to S3 via OIDC
        env:
          S3_URI: s3://REPLACE-ME-demo-bucket/${{ github.repository }}/${{ github.run_id }}/
        run: |
          echo "Uploading artifacts to $S3_URI"
          mkdir -p output
          ls -la output
          # Uncomment below to actually upload to S3 (replace bucket name)
          # aws s3 cp output/ $S3_URI --recursive

  kyverno-check:
    runs-on: ubuntu-latest
    needs: generate-and-scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Kyverno CLI (example)
        run: |
          # If you want to run Kyverno policies in CI without cluster, use kyverno CLI
          docker run --rm -v "${{ github.workspace }}:/workspace" ghcr.io/kyverno/kyverno:latest kyverno test /workspace/policies || true

  notes:
    runs-on: ubuntu-latest
    needs: [generate-and-scan, kyverno-check]
    steps:
      - name: Output artifacts list
        run: ls -la output || true
