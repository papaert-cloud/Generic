name: Scan â†’ Security Hub (ingest)

on:
  workflow_run:
    workflows: ["SBOM & SCA Pipeline"]
    types: [completed]

permissions:
  id-token: write
  contents: read

jobs:
  ingest-findings:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: sbom-and-grype

      - name: Convert to ASFF and push to Security Hub
        run: |
          GRYPE_SCRIPT=github-actions/devsecops/solution-05-security-platform/scripts/grype_to_asff.py
          python3 ${GRYPE_SCRIPT} \
            --input grype.json \
            --output asff.json

      - name: Publish findings to Security Hub (requires role with securityhub:BatchImportFindings)
        env:
          AWS_REGION: us-east-1
          AWS_ACCOUNT_ID: 005965605891
        run: |
          # Configure creds via OIDC role with Security Hub permissions
          aws sts get-caller-identity
          # aws securityhub batch-import-findings --findings file://asff.json --region ${AWS_REGION}
          echo "To push to Security Hub, enable the above aws cli command and ensure role perms"
