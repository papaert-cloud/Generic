---
name: Secure CICD GHA - build & deploy (example)

on:
  workflow_dispatch: true
  push:
    branches:
      - main

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11
      - name: Install deps and build lambda
        run: |
          cd Infra/solutions/scenario-s003-000-secure-cicd-gha
          ./build.sh
      - name: Upload to S3
        env:
          AWS_REGION: us-east-1
        run: |
          WORKDIR=Infra/solutions/scenario-s003-000-secure-cicd-gha
          cd ${WORKDIR}
          ./upload.sh \
            "${{ secrets.LAMBDA_DEPLOY_BUCKET }}" remediate/remediate.zip

  tf-lint-validate:
    runs-on: ubuntu-latest
    container:
      image: hashicorp/terraform:1.6.0
    steps:
      - uses: actions/checkout@v4
      - name: terraform fmt and validate
        env:
          WORK_TF_DIR: >-
            Infra/solutions/scenario-s003-000-secure-cicd-gha/
            terraform
        working-directory: ${{ env.WORK_TF_DIR }}
        run: |
          terraform init -input=false
          terraform fmt -recursive
          terraform validate || true

  terragrunt-apply:
    needs: [build-and-upload, tf-lint-validate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.DEPLOY_ROLE_ARN }}
          aws-region: us-east-1
      - name: Install Terraform and Terragrunt
        run: |
          sudo apt-get update && sudo apt-get install -y unzip
          TF_URL_BASE: >
            https://releases.hashicorp.com/terraform/1.6.0
          TF_URL=${TF_URL_BASE}/terraform_1.6.0_linux_amd64.zip
          curl -Lo tf.zip ${TF_URL}
          unzip tf.zip -d /usr/local/bin
          TG_BASE: >
            https://github.com/gruntwork-io/terragrunt/releases/download/v0.45.0
          TG_URL=${TG_BASE}/terragrunt_linux_amd64
          curl -Lo terragrunt ${TG_URL}
          chmod +x terragrunt && sudo mv terragrunt /usr/local/bin/
      - name: Terragrunt apply (plan only by default)
        env:
          AWS_REGION: us-east-1
        run: |
          cd Infra/solutions/scenario-s003-000-secure-cicd-gha
          terragrunt init
          terragrunt plan
